name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  # Build Rust libraries
  build-rust:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        cuda: ['12.3', '11.8']
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-action@stable
      
    - name: Setup CUDA (Linux)
      if: runner.os == 'Linux'
      uses: Jimver/cuda-toolkit@v0.2.11
      with:
        cuda: ${{ matrix.cuda }}
        
    - name: Setup CUDA (Windows)
      if: runner.os == 'Windows'
      uses: Jimver/cuda-toolkit@v0.2.11
      with:
        cuda: ${{ matrix.cuda }}
    
    - name: Build (CUDA 12)
      if: startsWith(matrix.cuda, '12')
      run: cargo build --release --features cuda-12
      
    - name: Build (CUDA 11)
      if: startsWith(matrix.cuda, '11')
      run: cargo build --release --features cuda-11
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: cudars-ffi-${{ runner.os }}-cuda${{ matrix.cuda }}
        path: |
          target/release/cudars_ffi.dll
          target/release/libcudars_ffi.so
          target/release/libcudars_ffi.dylib

  # Build .NET libraries
  build-dotnet:
    needs: build-rust
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Organize native libraries
      run: |
        mkdir -p dotnet/CudaRS.Native/runtimes/win-x64/native
        mkdir -p dotnet/CudaRS.Native/runtimes/linux-x64/native
        cp artifacts/cudars-ffi-Windows-cuda12.3/cudars_ffi.dll dotnet/CudaRS.Native/runtimes/win-x64/native/ || true
        cp artifacts/cudars-ffi-Linux-cuda12.3/libcudars_ffi.so dotnet/CudaRS.Native/runtimes/linux-x64/native/ || true
    
    - name: Build .NET
      run: dotnet build dotnet/CudaRS.sln -c Release -p:TreatWarningsAsErrors=true
    
    - name: Pack NuGet
      run: |
        dotnet pack dotnet/CudaRS.Native/CudaRS.Native.csproj -c Release -o nupkg -p:TreatWarningsAsErrors=true
        dotnet pack dotnet/CudaRS.Core/CudaRS.Core.csproj -c Release -o nupkg -p:TreatWarningsAsErrors=true
        dotnet pack dotnet/CudaRS/CudaRS.csproj -c Release -o nupkg -p:TreatWarningsAsErrors=true
    
    - name: Upload NuGet packages
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: nupkg/*.nupkg

  # Release job
  release:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [build-rust, build-dotnet]
    runs-on: ubuntu-latest
    
    steps:
    - name: Download NuGet packages
      uses: actions/download-artifact@v4
      with:
        name: nuget-packages
        path: nupkg
    
    - name: Publish to NuGet
      run: |
        dotnet nuget push nupkg/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
      if: ${{ secrets.NUGET_API_KEY != '' }}
